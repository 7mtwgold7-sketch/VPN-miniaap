<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMMORTAL VPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0; padding: 0; font-family: 'Tahoma', sans-serif;
            background-color: #000; color: white; overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            padding-bottom: 90px; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* پس زمینه گلادیاتور */
        .bg-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.3; object-fit: cover;
            background: url('bg.gif') no-repeat center center / cover;
        }

        .page { display: none; width: 100%; max-width: 400px; animation: fade 0.2s; padding-bottom: 100px; }
        .page.active { display: flex; flex-direction: column; align-items: center; }
        @keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* هدر */
        .logo-box {
            width: 100px; height: 100px; margin: 30px auto 10px;
            border-radius: 50%; border: 3px solid #00f3ff;
            box-shadow: 0 0 20px #00f3ff; overflow: hidden; background: #000;
        }
        .logo-box img { width: 100%; height: 100%; object-fit: cover; }
        .app-title { font-size: 20px; font-weight: bold; color: #00f3ff; text-shadow: 0 0 10px #00f3ff; margin-bottom: 20px; }

        /* کارت ها */
        .card {
            background: rgba(30, 30, 30, 0.85); width: 85%; padding: 20px;
            border-radius: 18px; text-align: center; margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(8px);
        }
        
        .plan-item {
            background: rgba(255,255,255,0.05); width: 90%; padding: 15px;
            border-radius: 15px; margin-bottom: 10px; display: flex;
            justify-content: space-between; align-items: center; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
        }
        .plan-item:active { background: rgba(0, 243, 255, 0.1); border-color: #00f3ff; }
        
        .btn {
            background: linear-gradient(90deg, #00f3ff, #0066ff); color: #000;
            border: none; padding: 12px; width: 100%; border-radius: 12px;
            font-weight: bold; font-size: 15px; margin-top: 10px; cursor: pointer;
        }
        .btn:active { transform: scale(0.97); }
        .btn-red { background: linear-gradient(90deg, #ff4444, #cc0000); color: white; }

        /* اینپوت */
        input, select {
            width: 90%; padding: 12px; background: rgba(0,0,0,0.6);
            border: 1px solid #555; border-radius: 10px; color: white;
            margin-bottom: 10px; font-family: inherit; text-align: center; font-size: 16px;
        }
        input:focus { border-color: #00f3ff; outline: none; }

        /* نوار پایین */
        .nav {
            position: fixed; bottom: 20px; width: 90%; height: 65px;
            background: rgba(15, 15, 15, 0.95); border-radius: 40px;
            display: flex; justify-content: space-around; align-items: center;
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px #000; z-index: 999;
        }
        .nav-icon { color: #666; font-size: 24px; padding: 10px; transition: 0.3s; }
        .nav-icon.active {
            color: #000; background: #00f3ff; border-radius: 50%;
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px #00f3ff; transform: translateY(-10px);
        }
    </style>
</head>
<body>
    <div class="bg-video"></div>

    <div id="home" class="page active">
        <div class="logo-box"><img src="logo.jpg"></div>
        <div class="app-title">IMMORTAL VPN</div>

        <div class="card">
            <div style="font-size: 12px; color: #aaa;">موجودی کیف پول</div>
            <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="balDisplay">0 تومان</div>
            <button class="btn" onclick="nav('wallet')">افزایش موجودی</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%;">
            <div class="card" style="width: auto; margin:0;" onclick="nav('shop')">
                <i class="fas fa-shopping-cart" style="font-size:25px; color:#00f3ff; margin-bottom:10px;"></i>
                <div style="font-size:13px;">خرید اشتراک</div>
            </div>
            <div class="card" style="width: auto; margin:0;" onclick="send('open_services')">
                <i class="fas fa-server" style="font-size:25px; color:#00f3ff; margin-bottom:10px;"></i>
                <div style="font-size:13px;">سرویس‌های من</div>
            </div>
        </div>
    </div>

    <div id="shop" class="page">
        <h2 style="color:#00f3ff;">فروشگاه</h2>
        <div id="plans-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <p style="color: #aaa;">در حال بارگیری پلن‌ها...</p>
        </div>
    </div>

    <div id="wallet" class="page">
        <h2 style="color:#00f3ff;">شارژ حساب</h2>
        
        <div id="wallet-main" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="card" onclick="showCrypto()">
                <i class="fas fa-coins" style="font-size:30px; color:orange; margin-bottom:10px;"></i>
                <h3>شارژ ارزی / کریپتو</h3>
                <p style="font-size:11px; color:#aaa;">USDT, TRX, ...</p>
            </div>
            <div class="card" onclick="showStars()">
                <i class="fas fa-star" style="font-size:30px; color:yellow; margin-bottom:10px;"></i>
                <h3>شارژ با Stars</h3>
                <p style="font-size:11px; color:#aaa;">تلگرام استارز</p>
            </div>
        </div>

        <div id="wallet-crypto" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <div class="card">
                <h3>1. انتخاب ارز</h3>
                <select id="coinSelect" onchange="updateNetworks()">
                    <option value="usdt">USDT (تتر)</option>
                    <option value="trx">TRX (ترون)</option>
                </select>
                
                <h3>2. انتخاب شبکه</h3>
                <select id="netSelect">
                    <option value="trc20">TRC20</option>
                    <option value="erc20">ERC20</option>
                    <option value="bep20">BEP20</option>
                </select>

                <h3>3. مقدار</h3>
                <input type="number" id="cryptoAmount" placeholder="مثلاً 10">
                
                <button class="btn" onclick="submitCrypto()">ادامه و پرداخت</button>
                <button class="btn btn-red" onclick="resetWallet()">بازگشت</button>
            </div>
        </div>

        <div id="wallet-stars" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <div class="card">
                <i class="fas fa-star" style="color:yellow; font-size:40px;"></i>
                <p>تعداد استارز را وارد کنید:</p>
                <input type="number" id="starsAmount" placeholder="50">
                <button class="btn" onclick="submitStars()">پرداخت</button>
                <button class="btn btn-red" onclick="resetWallet()">بازگشت</button>
            </div>
        </div>
    </div>

    <div id="support" class="page">
        <h2 style="color:#00f3ff;">پشتیبانی</h2>
        <div class="card">
            <p>پیام خود را بنویسید:</p>
            <input type="text" id="ticketMsg" placeholder="متن پیام..." style="height: 100px;">
            <button class="btn" onclick="sendTicket()">ارسال</button>
        </div>
        <button class="btn btn-red" style="width:85%;" onclick="tg.close()">خروج</button>
    </div>

    <div class="nav">
        <div class="nav-icon" onclick="nav('support')"><i class="fas fa-headset"></i></div>
        <div class="nav-icon" onclick="nav('shop')"><i class="fas fa-shopping-cart"></i></div>
        <div class="nav-icon" onclick="nav('wallet')"><i class="fas fa-wallet"></i></div>
        <div class="nav-icon active" onclick="nav('home')"><i class="fas fa-home"></i></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 
        tg.setHeaderColor('#000000');
        try { updateNetworks(); } catch(e) {}

        // دریافت اطلاعات از URL (اینجا لیست پلن‌ها از ربات میاد)
        const params = new URLSearchParams(window.location.search);
        const bal = parseInt(params.get('bal') || 0).toLocaleString();
        const plansRaw = params.get('plans') || ""; 
        
        
        const reg = params.get('reg') || 'fa';
        const currencyLabel = (reg === 'fa') ? 'تومان' : (reg === 'tr') ? 'TL' : (reg === 'ae') ? 'AED' : (reg === 'ru') ? '₽' : (reg === 'cn') ? '¥' : '$';
        document.getElementById('balDisplay').innerText = bal + " " + currencyLabel;

        // ساخت لیست پلن‌ها
        const container = document.getElementById('plans-container');
        if (plansRaw) {
            container.innerHTML = "";
            // فرمت دیتا: id-name-price-gb_id-name...
            const list = plansRaw.split('_');
            list.forEach(item => {
                if(!item) return;
                const [id, name, price, gb] = item.split('-');
                const div = document.createElement('div');
                div.className = 'plan-item';
                div.innerHTML = `
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:white;">${decodeURIComponent(name)}</div>
                        <div style="font-size:12px; color:#aaa;">${gb} گیگابایت</div>
                    </div>
                    <div style="text-align:left;">
                        <div style="color:#00f3ff; font-weight:bold;">${parseInt(price).toLocaleString()} ت</div>
                    </div>
                `;
                div.onclick = () => {
                    if(confirm(`آیا مطمئن هستید؟\nخرید: ${decodeURIComponent(name)}`)) {
                        send('execute_buy', id);
                    }
                };
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p style="color:red;">لیست پلن‌ها خالی است یا دریافت نشد.</p>';
        }

        // توابع ناوبری
        function nav(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            const idx = ['support','shop','wallet','home'].indexOf(page);
            if(idx>=0) document.querySelectorAll('.nav-icon')[idx].classList.add('active');
        }

        function resetWallet() {
            document.getElementById('wallet-crypto').style.display = 'none';
            document.getElementById('wallet-stars').style.display = 'none';
            document.getElementById('wallet-main').style.display = 'flex';
        }
        function showCrypto() {
            document.getElementById('wallet-main').style.display = 'none';
            document.getElementById('wallet-crypto').style.display = 'flex';
        }
        function showStars() {
            document.getElementById('wallet-main').style.display = 'none';
            document.getElementById('wallet-stars').style.display = 'flex';
        }

        // ارسال به ربات
        function send(action, payload=null) {
            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e) {}
            const data = JSON.stringify({ action, payload });
            try { tg.sendData(data); } catch(e) { console.error(e); alert('ارسال به ربات ناموفق بود.'); return; }
            // به کاربر بگو نتیجه داخل چت میاد (بدون تغییر UI)
            try { tg.showToast({ text: 'درخواست ارسال شد؛ نتیجه داخل چت ربات نمایش داده می‌شود.' }); } catch(e) {}
        }

        // لاجیک‌های دکمه‌ها
        function submitCrypto() {
            const coin = document.getElementById('coinSelect').value;
            const net = document.getElementById('netSelect').value;
            const amt = document.getElementById('cryptoAmount').value;
            if(!amt) return alert('مقدار را وارد کنید');
            // فرمت: coin:net:amount
            send('execute_crypto_pay', `${coin}:${net}:${amt}`);
        }

        function submitStars() {
            const val = document.getElementById('starsAmount').value;
            if(val) send('topup_stars', val);
        }

        function sendTicket() {
            const txt = document.getElementById('ticketMsg').value;
            if(txt) send('execute_ticket', txt);
        }
        
        function updateNetworks() {
            const c = document.getElementById('coinSelect').value;
            const n = document.getElementById('netSelect');
            n.innerHTML = '';
            if(c === 'trx') n.innerHTML = '<option value="trc20">TRC20</option>';
            else n.innerHTML = '<option value="trc20">TRC20</option><option value="erc20">ERC20</option><option value="bep20">BEP20</option>';
        }
    </script>
</body>
</html>
